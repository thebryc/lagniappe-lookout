<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lagniappe Lookout</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-700 via-green-600 to-yellow-500">
    <div id="app"></div>

    <script>
        const SHEET_ID = '1k1Pyl4j-oMn1SCwAvd2dPuqdN3Rx6yfkY4SgJqhg6cI';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;
        const FORM_ID = '1FAIpQLScFmiAQlM7_WuQt7sLbb9D24wtRpziwJwiqtI-XRDOTZHBzUA';
        
        const LANDMARKS = [
            'Superdome', 'Streetcar', 'Beignet Shop', 'Blue Dog', 'Mural',
            'Cajun Cuisine', 'Tulane University', 'Street Performer', 'Balcony',
            'Dillard University', 'Random Beads', 'Gumbo Restaurant', 'Jambalaya Restaurant',
            'Snowball Stand', 'Lawyer Billboard', 'Xavier University', 'Anything Saints',
            'Student Union', 'Delgado Community College', 'Second Line',
            'Crescent City Connection Bridge', 'Tourists', 'Anything Pelicans',
            'Tour Bus', 'Students Touring'
        ];

        let currentUser = '';
        let isLoggedIn = false;
        let allData = [];
        let currentView = 'checklist';

        async function loadData() {
            try {
                const response = await fetch(SHEET_URL);
                const csvText = await response.text();
                const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
                
                allData = parsed.data.filter(row => row.Name && row.Landmark);
                
                if (isLoggedIn) {
                    updateDisplay();
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function saveData(name, landmark) {
            const formData = new FormData();
            formData.append('entry.411262238', name);
            formData.append('entry.34827782', landmark);

            try {
                await fetch(`https://docs.google.com/forms/d/e/${FORM_ID}/formResponse`, {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors'
                });
                setTimeout(loadData, 1500);
            } catch (error) {
                console.error('Error saving:', error);
            }
        }

        function getUserLandmarks(name) {
            return new Set(allData.filter(row => row.Name === name).map(row => row.Landmark));
        }

        function getLeaderboard() {
            const userScores = {};
            
            allData.forEach(row => {
                if (!userScores[row.Name]) {
                    userScores[row.Name] = { landmarks: new Set(), timestamp: new Date(row.Timestamp).getTime() };
                }
                userScores[row.Name].landmarks.add(row.Landmark);
            });

            return Object.keys(userScores)
                .map(name => ({ name, score: userScores[name].landmarks.size, timestamp: userScores[name].timestamp }))
                .sort((a, b) => b.score !== a.score ? b.score - a.score : a.timestamp - b.timestamp);
        }

        function showLogin() {
            document.getElementById('app').innerHTML = `
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                        <div class="text-center mb-6">
                            <div class="text-6xl mb-4">üèÜ</div>
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">Lagniappe Lookout</h1>
                            <p class="text-gray-600">Find all 25 landmarks around New Orleans!</p>
                        </div>
                        <div class="space-y-4">
                            <input
                                type="text"
                                id="nameInput"
                                class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                                placeholder="Enter your name..."
                            />
                            <button
                                id="startBtn"
                                class="w-full bg-gradient-to-r from-purple-600 via-green-600 to-yellow-500 text-white font-bold py-3 rounded-lg hover:shadow-xl transition-all"
                            >
                                <div>Press here to</div>
                                <div>laissez les bons temps rouler! üé∫</div>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('startBtn').onclick = function() {
                const name = document.getElementById('nameInput').value.trim();
                if (name) {
                    currentUser = name;
                    isLoggedIn = true;
                    showMain();
                } else {
                    alert('Please enter your name!');
                }
            };

            document.getElementById('nameInput').onkeypress = function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('startBtn').click();
                }
            };
        }

        function showMain() {
            updateDisplay();
        }

        function updateDisplay() {
            const userLandmarks = getUserLandmarks(currentUser);
            const leaderboard = getLeaderboard();
            const myProgress = userLandmarks.size;
            const myRank = leaderboard.findIndex(p => p.name === currentUser) + 1;
            const progressPercent = (myProgress / LANDMARKS.length) * 100;
            const rankDisplay = myRank === 1 ? 'ü•á' : myRank === 2 ? 'ü•à' : myRank === 3 ? 'ü•â' : myRank > 0 ? `#${myRank}` : '-';

            document.getElementById('app').innerHTML = `
                <div class="p-4">
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-xl p-6 mb-4">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h1 class="text-2xl font-bold text-gray-800">Hey, ${currentUser}! üëã</h1>
                                    <p class="text-gray-600">${myProgress}/${LANDMARKS.length} landmarks found</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-3xl font-bold text-purple-600">${rankDisplay}</div>
                                    <p class="text-sm text-gray-600">Your Rank</p>
                                </div>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                <div class="bg-gradient-to-r from-purple-600 via-green-600 to-yellow-500 h-full transition-all duration-500" style="width: ${progressPercent}%"></div>
                            </div>
                        </div>

                        <div class="flex gap-2 mb-4">
                            <button id="checklistBtn" class="flex-1 py-3 rounded-xl font-bold transition-all ${currentView === 'checklist' ? 'bg-white text-purple-600 shadow-lg' : 'bg-white/30 text-white'}">
                                My Checklist
                            </button>
                            <button id="leaderboardBtn" class="flex-1 py-3 rounded-xl font-bold transition-all ${currentView === 'leaderboard' ? 'bg-white text-purple-600 shadow-lg' : 'bg-white/30 text-white'}">
                                Leaderboard üèÜ
                            </button>
                        </div>

                        <div class="bg-white rounded-2xl shadow-xl p-6 mb-4">
                            <div id="content"></div>
                        </div>

                        <button id="logoutBtn" class="w-full bg-white/30 text-white py-3 rounded-xl font-medium hover:bg-white/40 transition-all">
                            Switch User
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('checklistBtn').onclick = function() {
                currentView = 'checklist';
                updateContent();
            };

            document.getElementById('leaderboardBtn').onclick = function() {
                currentView = 'leaderboard';
                updateContent();
            };

            document.getElementById('logoutBtn').onclick = function() {
                isLoggedIn = false;
                currentUser = '';
                showLogin();
            };

            updateContent();
        }

        function updateContent() {
            const content = document.getElementById('content');
            if (currentView === 'checklist') {
                showChecklist(content);
            } else {
                showLeaderboard(content);
            }
        }

        function showChecklist(container) {
            const userLandmarks = getUserLandmarks(currentUser);
            
            let html = '<h2 class="text-xl font-bold text-gray-800 mb-4">Check off what you find!</h2><div class="space-y-2">';
            
            LANDMARKS.forEach(landmark => {
                const checked = userLandmarks.has(landmark);
                html += `
                    <button class="landmark-btn w-full flex items-center justify-between p-4 rounded-lg transition-all ${checked ? 'bg-green-50 border-2 border-green-500' : 'bg-gray-50 border-2 border-gray-200 hover:border-purple-300'}" data-landmark="${landmark}">
                        <span class="font-medium ${checked ? 'text-green-700' : 'text-gray-700'}">${landmark}</span>
                        <div class="w-6 h-6 rounded-full flex items-center justify-center ${checked ? 'bg-green-500' : 'bg-gray-300'}">
                            ${checked ? '<span class="text-white text-sm">‚úì</span>' : ''}
                        </div>
                    </button>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;

            document.querySelectorAll('.landmark-btn').forEach(btn => {
                btn.onclick = function() {
                    const landmark = this.getAttribute('data-landmark');
                    const userLandmarks = getUserLandmarks(currentUser);
                    if (userLandmarks.has(landmark)) {
                        alert('You already checked this one! üé≠');
                    } else {
                        saveData(currentUser, landmark);
                    }
                };
            });
        }

        function showLeaderboard(container) {
            const leaderboard = getLeaderboard();
            
            let html = '<h2 class="text-xl font-bold text-gray-800 mb-4">Live Rankings üî•</h2><div class="space-y-3">';
            
            if (leaderboard.length === 0) {
                html += '<p class="text-center text-gray-500 py-8">No one has found anything yet!</p>';
            } else {
                leaderboard.forEach((player, index) => {
                    const isMe = player.name === currentUser;
                    const rank = index + 1;
                    const rankEmoji = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : rank;
                    
                    let bgColor = 'bg-gray-50 border-gray-200';
                    if (isMe) bgColor = 'bg-purple-50 border-purple-500';
                    else if (rank === 1) bgColor = 'bg-yellow-50 border-yellow-400';
                    else if (rank === 2) bgColor = 'bg-gray-50 border-gray-400';
                    else if (rank === 3) bgColor = 'bg-orange-50 border-orange-400';
                    
                    html += `
                        <div class="flex items-center justify-between p-4 rounded-lg border-2 ${bgColor}">
                            <div class="flex items-center gap-4">
                                <div class="text-2xl font-bold w-8 text-center">${rankEmoji}</div>
                                <div>
                                    <div class="font-bold ${isMe ? 'text-purple-700' : 'text-gray-800'}">
                                        ${player.name} ${isMe ? '(You!)' : ''}
                                    </div>
                                    <div class="text-sm text-gray-600">${player.score}/${LANDMARKS.length} landmarks</div>
                                </div>
                            </div>
                            <div class="text-2xl font-bold text-purple-600">${player.score}</div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Auto-refresh every 5 seconds (only when logged in)
        setInterval(() => {
            if (isLoggedIn) loadData();
        }, 5000);

        // Start
        loadData();
        showLogin();
    </script>
</body>
</html>
