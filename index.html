<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lagniappe Lookout</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script>
        const SHEET_ID = '1k1Pyl4j-oMn1SCwAvd2dPuqdN3Rx6yfkY4SgJqhg6cI';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv`;
        const FORM_ID = '1FAIpQLScFmiAQlM7_WuQt7sLbb9D24wtRpziwJwiqtI-XRDOTZHBzUA';
        
        const LANDMARKS = [
            'Superdome', 'Streetcar', 'Beignet Shop', 'Blue Dog', 'Mural',
            'Cajun Cuisine', 'Tulane University', 'Street Performer', 'Balcony',
            'Dillard University', 'Random Beads', 'Gumbo Restaurant', 'Jambalaya Restaurant',
            'Snowball Stand', 'Lawyer Billboard', 'Xavier University', 'Anything Saints',
            'Student Union', 'Delgado Community College', 'Second Line',
            'Crescent City Connection Bridge', 'Tourists', 'Anything Pelicans',
            'Tour Bus', 'Students Touring'
        ];

        let state = {
            currentUser: '',
            isLoggedIn: false,
            allData: [],
            view: 'checklist',
            loadingError: false
        };

        async function loadDataFromSheet() {
            try {
                const response = await fetch(SHEET_URL);
                if (!response.ok) throw new Error('Failed to fetch');
                
                const csvText = await response.text();
                const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
                
                state.allData = parsed.data
                    .map(row => ({
                        Name: row.Name || row.name,
                        Landmark: row.Landmark || row.landmark,
                        Timestamp: row.Timestamp || row.timestamp || new Date().toISOString()
                    }))
                    .filter(row => row.Name && row.Landmark);
                
                state.loadingError = false;
                
                // Only re-render if logged in (don't interrupt login screen)
                if (state.isLoggedIn) {
                    render();
                }
            } catch (error) {
                console.error('Error loading data:', error);
                state.loadingError = true;
            }
        }

        async function saveToSheet(name, landmark) {
            const formData = new FormData();
            formData.append('entry.411262238', name);
            formData.append('entry.34827782', landmark);

            try {
                await fetch(`https://docs.google.com/forms/d/e/${FORM_ID}/formResponse`, {
                    method: 'POST',
                    body: formData,
                    mode: 'no-cors'
                });
                setTimeout(loadDataFromSheet, 1500);
            } catch (error) {
                console.error('Error saving:', error);
            }
        }

        function getUserLandmarks(name) {
            return new Set(
                state.allData
                    .filter(row => row.Name === name)
                    .map(row => row.Landmark)
            );
        }

        function getLeaderboard() {
            const userScores = {};
            
            state.allData.forEach(row => {
                if (!userScores[row.Name]) {
                    userScores[row.Name] = {
                        landmarks: new Set(),
                        timestamp: new Date(row.Timestamp).getTime()
                    };
                }
                userScores[row.Name].landmarks.add(row.Landmark);
            });

            return Object.keys(userScores)
                .map(name => ({
                    name,
                    score: userScores[name].landmarks.size,
                    timestamp: userScores[name].timestamp
                }))
                .sort((a, b) => {
                    if (b.score !== a.score) return b.score - a.score;
                    return a.timestamp - b.timestamp;
                });
        }

        function toggleLandmark(landmark) {
            const userLandmarks = getUserLandmarks(state.currentUser);
            if (userLandmarks.has(landmark)) {
                alert('You already checked this one! ğŸ­');
            } else {
                saveToSheet(state.currentUser, landmark);
            }
        }

        function handleLogin() {
            const input = document.getElementById('nameInput');
            const name = input ? input.value.trim() : '';
            console.log('Login attempted with name:', name);
            if (name) {
                state.currentUser = name;
                state.isLoggedIn = true;
                console.log('Login successful, rendering main app');
                render();
            } else {
                alert('Please enter your name!');
            }
        }

        function logout() {
            state.isLoggedIn = false;
            state.currentUser = '';
            render();
        }

        function switchView(newView) {
            state.view = newView;
            render();
        }

        // Make functions globally accessible
        window.toggleLandmark = function(landmark) {
            toggleLandmark(landmark);
        };
        window.handleLogin = function() {
            handleLogin();
        };
        window.logout = function() {
            logout();
        };
        window.switchView = function(view) {
            switchView(view);
        };

        function render() {
            const root = document.getElementById('root');
            root.innerHTML = state.isLoggedIn ? renderMainApp() : renderLoginScreen();
            
            // Attach event listeners after rendering
            if (!state.isLoggedIn) {
                const loginBtn = document.getElementById('loginBtn');
                const nameInput = document.getElementById('nameInput');
                
                if (loginBtn) {
                    loginBtn.addEventListener('click', handleLogin);
                }
                if (nameInput) {
                    nameInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') handleLogin();
                    });
                }
            } else {
                // Attach event listeners for main app
                const checklistBtn = document.getElementById('checklistBtn');
                const leaderboardBtn = document.getElementById('leaderboardBtn');
                const logoutBtn = document.getElementById('logoutBtn');
                
                if (checklistBtn) checklistBtn.addEventListener('click', () => switchView('checklist'));
                if (leaderboardBtn) leaderboardBtn.addEventListener('click', () => switchView('leaderboard'));
                if (logoutBtn) logoutBtn.addEventListener('click', logout);
                
                // Attach landmark button listeners
                const landmarkBtns = document.querySelectorAll('[data-landmark]');
                landmarkBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        toggleLandmark(this.getAttribute('data-landmark'));
                    });
                });
            }
        }

        function renderLoginScreen() {
            return `
                <div class="min-h-screen bg-gradient-to-br from-purple-700 via-green-600 to-yellow-500 flex items-center justify-center p-4">
                    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                        <div class="text-center mb-6">
                            <div class="w-16 h-16 mx-auto mb-4 text-6xl">ğŸ†</div>
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">Lagniappe Lookout</h1>
                            <p class="text-gray-600">Find all 25 landmarks around New Orleans!</p>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Enter Your Name</label>
                                <input
                                    type="text"
                                    id="nameInput"
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none"
                                    placeholder="Your name..."
                                />
                            </div>
                            <button
                                id="loginBtn"
                                type="button"
                                class="w-full bg-gradient-to-r from-purple-600 via-green-600 to-yellow-500 text-white font-bold py-3 rounded-lg hover:shadow-xl transition-all"
                            >
                                <div>Press here to</div>
                                <div>laissez les bons temps rouler! ğŸº</div>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMainApp() {
            const leaderboard = getLeaderboard();
            const userLandmarks = getUserLandmarks(state.currentUser);
            const myProgress = userLandmarks.size;
            const myRank = leaderboard.findIndex(p => p.name === state.currentUser) + 1;
            const progressPercent = (myProgress / LANDMARKS.length) * 100;
            const rankDisplay = myRank === 1 ? 'ğŸ¥‡' : myRank === 2 ? 'ğŸ¥ˆ' : myRank === 3 ? 'ğŸ¥‰' : myRank > 0 ? `#${myRank}` : '-';

            return `
                <div class="min-h-screen bg-gradient-to-br from-purple-700 via-green-600 to-yellow-500 p-4">
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-white rounded-2xl shadow-xl p-6 mb-4">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h1 class="text-2xl font-bold text-gray-800">Hey, ${state.currentUser}! ğŸ‘‹</h1>
                                    <p class="text-gray-600">${myProgress}/${LANDMARKS.length} landmarks found</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-3xl font-bold text-purple-600">${rankDisplay}</div>
                                    <p class="text-sm text-gray-600">Your Rank</p>
                                </div>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                                <div class="bg-gradient-to-r from-purple-600 via-green-600 to-yellow-500 h-full transition-all duration-500" style="width: ${progressPercent}%"></div>
                            </div>
                        </div>

                        <div class="flex gap-2 mb-4">
                            <button
                                id="checklistBtn"
                                type="button"
                                class="flex-1 py-3 rounded-xl font-bold transition-all ${
                                    state.view === 'checklist'
                                        ? 'bg-white text-purple-600 shadow-lg'
                                        : 'bg-white/30 text-white'
                                }"
                            >
                                My Checklist
                            </button>
                            <button
                                id="leaderboardBtn"
                                type="button"
                                class="flex-1 py-3 rounded-xl font-bold transition-all ${
                                    state.view === 'leaderboard'
                                        ? 'bg-white text-purple-600 shadow-lg'
                                        : 'bg-white/30 text-white'
                                }"
                            >
                                Leaderboard ğŸ†
                            </button>
                        </div>

                        <div class="bg-white rounded-2xl shadow-xl p-6">
                            ${state.view === 'checklist' ? renderChecklist(userLandmarks) : renderLeaderboard(leaderboard)}
                        </div>

                        <button
                            id="logoutBtn"
                            type="button"
                            class="w-full mt-4 bg-white/30 text-white py-3 rounded-xl font-medium hover:bg-white/40 transition-all"
                        >
                            Switch User
                        </button>
                    </div>
                </div>
            `;
        }

        function renderChecklist(userLandmarks) {
            return `
                <div class="space-y-2">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Check off what you find!</h2>
                    ${LANDMARKS.map(landmark => {
                        const checked = userLandmarks.has(landmark);
                        return `
                            <button
                                type="button"
                                data-landmark="${landmark}"
                                class="w-full flex items-center justify-between p-4 rounded-lg transition-all ${
                                    checked
                                        ? 'bg-green-50 border-2 border-green-500'
                                        : 'bg-gray-50 border-2 border-gray-200 hover:border-purple-300'
                                }"
                            >
                                <span class="font-medium ${checked ? 'text-green-700' : 'text-gray-700'}">${landmark}</span>
                                <div class="w-6 h-6 rounded-full flex items-center justify-center ${
                                    checked ? 'bg-green-500' : 'bg-gray-300'
                                }">
                                    ${checked ? '<span class="text-white text-sm">âœ“</span>' : ''}
                                </div>
                            </button>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderLeaderboard(leaderboard) {
            return `
                <div class="space-y-3">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Live Rankings ğŸ”¥</h2>
                    ${leaderboard.length === 0 ? '<p class="text-center text-gray-500 py-8">No one has found anything yet!</p>' : ''}
                    ${leaderboard.map((player, index) => {
                        const isMe = player.name === state.currentUser;
                        const rank = index + 1;
                        const rankEmoji = rank === 1 ? 'ğŸ¥‡' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : rank;
                        
                        let bgColor = 'bg-gray-50 border-gray-200';
                        if (isMe) {
                            bgColor = 'bg-purple-50 border-purple-500';
                        } else if (rank === 1) {
                            bgColor = 'bg-yellow-50 border-yellow-400';
                        } else if (rank === 2) {
                            bgColor = 'bg-gray-50 border-gray-400';
                        } else if (rank === 3) {
                            bgColor = 'bg-orange-50 border-orange-400';
                        }
                        
                        return `
                            <div class="flex items-center justify-between p-4 rounded-lg transition-all border-2 ${bgColor}">
                                <div class="flex items-center gap-4">
                                    <div class="text-2xl font-bold w-8 text-center">${rankEmoji}</div>
                                    <div>
                                        <div class="font-bold ${isMe ? 'text-purple-700' : 'text-gray-800'}">
                                            ${player.name} ${isMe ? '(You!)' : ''}
                                        </div>
                                        <div class="text-sm text-gray-600">${player.score}/${LANDMARKS.length} landmarks</div>
                                    </div>
                                </div>
                                <div class="text-2xl font-bold text-purple-600">${player.score}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Auto-refresh every 5 seconds
        setInterval(loadDataFromSheet, 5000);

        // Initial load - don't render yet, just load data
        loadDataFromSheet();
        
        // Wait a moment before initial render to let data load
        setTimeout(() => {
            render();
        }, 500);
    </script>
</body>
</html>
